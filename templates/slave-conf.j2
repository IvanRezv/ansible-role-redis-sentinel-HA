# {{ ansible_managed }}
daemonize yes
pidfile /var/run/redis/{{ redis_daemon }}.pid
bind {{ redis_bind_loop }} {{ ansible_default_ipv4.address }}
port {{ redis_port }}
{% if redis_unixsocket %}
unixsocket {{ redis_unixsocket }}
{% endif %}
timeout {{ redis_timeout }}
loglevel {{ redis_loglevel }}
logfile {{ redis_logfile }}

databases {{ redis_databases }}
rdbcompression {{ redis_rdbcompression }}
dbfilename {{ redis_dbfilename }}
dir {{ redis_dbdir }}
{% if redis_maxmemory %}
maxmemory {{ redis_maxmemory }}
maxmemory-samples {{ redis_maxmemory_samples }}
{% endif %}

# Cache vs Session store options
{% if redis_cache %}
# Redis Cache Only Options
maxmemory-policy {{ cache_maxmemory_policy }}
{% endif %}
{% if redis_session %}
# Redis Session Store Options
{% for save in redis_save %}
save {{ save }}
{% endfor %}
maxmemory-policy {{ session_maxmemory_policy }}
{% endif %}
# END Cache vs Session store options
{% if appendfsync_no %}
appendfsync {{ appendfsync_no }}
{% endif %}
{% if appendfsync_always %}
appendfsync {{ appendfsync_always }}
{% endif %}
{% if appendfsync_everysec %}
appendfsync {{ appendfsync_everysec }}
{% endif %}
{% if no_appendfsync_on_rewrite == 'yes' %}
no-appendfsync-on-rewrite yes
{% else %}
no-appendfsync-on-rewrite no
{% endif %}
# Hardening Redis Settings
{% if redis_master_auth %}
masterauth "{{ redis_master_auth }}"
{% endif %}
{% if redis_requirepass %}
requirepass "{{ redis_requirepass }}"
{% endif %}
# End Hardening Redis Settings
{% for include in redis_includes %}
include {{ include }}
{% endfor %}
{% for redis_disabled_command in redis_disabled_commands %}
rename-command {{ redis_disabled_command }} ""
{% endfor %}

{% for redis_disabled_command in redis_disabled_commands %}
rename-command {{ redis_disabled_command }} ""
{% endfor %}

# Replication settings
{% for host in groups['redis-nodes'] %}
{% if hostvars[host]['redis_role'] == 'slave' %}
replicaof {{redis_masters}} {{ redis_port }}
{% endif %}
{% endfor %}
